{% extends "layout.html" %}
{% load static highlight_code %}

{% block title %}Webpay Oneclick Mall Diferido - Capturar transacción diferida{% endblock %}

{% block content %}

{% component "breadcrumbs" items=[
    {"name": "Inicio", "url": "/"},
    {"name": "Webpay Oneclick Mall Diferido", "url": "/oneclick-mall-diferido/start"},
    {"name": "Capturar pago", "url": "#"}
] %}{% endcomponent %}

<h1>Webpay Oneclick Mall Diferido - Capturar transacción diferida</h1>

<p class="mb-32">
    En este paso debemos capturar la transacción para realmente cobrar el dinero que había sido previamente
    reservado al autorizar la transacción.
</p>

<h2 id="request">Paso 1: Petición</h2>
<p class="mb-32">
    Para capturar una transacción necesitaremos el código de comercio de la tienda hija y Orden de compra de la tienda hija, 
    Código de autorización y monto a capturar. Se hace de la siguiente manera.
</p>

{% filter highlight_code:"python" %}
transaction = MallTransaction.build_for_integration(
        IntegrationCommerceCodes.ONECLICK_MALL_DEFERRED,
        IntegrationApiKeys.WEBPAY
)
response = transaction.capture(child_commerce_code, child_buy_order, authorization_code, amount)
{% endfilter %}

<h2 id="response" class="mt-32">Paso 2: Respuesta</h2>
<p class="mb-32">
    Una vez creada la transacción, recibirás los siguientes datos de respuesta:
</p>

{{ response_data|prettyjson|highlight_code:"json" }}

<h2 id="operations" class="mt-32">¡Transacción Capturada!</h2>
<p>
    Con la transacción capturada, puedes mostrar al usuario una página de éxito de la transacción, proporcionándole la confirmación de que el proceso se ha completado con éxito.
</p>
<p>
    <strong>Otras Utilidades: </strong>Después de confirmar la transacción, considera las siguientes utilidades adicionales:
</p>
<p>
    <strong>Reembolso: </strong> Evalúa la posibilidad de reversar o anular el pago según ciertas condiciones comerciales.
</p>
<p class="mb-32">
    <strong>Consulta de Estado: </strong>Hasta 7 días después de la transacción, puedes consultar su estado para obtener más detalles.
</p>

<form action="{% url 'oneclick_mall_deferred:refund' %}" method="get">
    <input type="hidden" name="buy_order" value="{{ buy_order }}">
    <input type="hidden" name="child_buy_order" value="{{ child_buy_order }}">
    <input type="hidden" name="child_commerce_code" value="{{ child_commerce_code }}">

    <div class="tbk-refund-card mb-32">
        <div class="input-container">
            <label class="tbk-label" for="amount">Monto a reembolsar:</label>
            <input type="text" id="amount" name="amount" class="tbk-input-text"
                   value="{{ response_data.captured_amount|default_if_none:0|floatformat:0 }}">
        </div>

        <div class="tbk-refund-button-container">
            <button type="submit" class="tbk-button primary">REEMBOLSAR</button>
            <a href="{% url 'oneclick_mall_deferred:status' %}?buy_order={{ buy_order }}" class="tbk-button primary">
            CONSULTAR ESTADO
            </a>
        </div>
    </div>
</form>

{% endblock %}
