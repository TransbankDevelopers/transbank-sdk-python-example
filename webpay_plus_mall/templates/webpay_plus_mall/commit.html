{% extends "layout.html" %}
{% load static highlight_code %}

{% block title %}Webpay Plus Mall - Confirmar transacción{% endblock %}

{% block content %}

{% component "breadcrumbs" items=[
    {"name": "Inicio", "url": "/"},
    {"name": "Webpay Plus Mall", "url": "/webpay-plus-mall/"},
    {"name": "Confirmar transacción", "url": "/webpay-plus-mall/commit"}
] %}{% endcomponent %}

<h1>Webpay Plus Mall - Confirmar transacción</h1>

<p class="mb-32">
    En este paso es importante confirmar la transacción para notificar a Transbank que hemos recibido
    exitosamente los detalles de la transacción. <b>Es importante destacar que si la confirmación no se realiza, la
        transacción será caducada.</b>
</p>

<h2 id="data">Paso 1 - Datos recibidos:</h2>
<p class="mb-32">
    Después de completar el flujo en el formulario de pago, recibirás un GET con la siguiente
    información:
</p>

{% filter highlight_code:"json" %}
    { "token_ws": "{{ token }}" }
{% endfilter %}

<h2 class="mt-32" id="request">Paso 2 - Petición:</h2>
<p class="mb-32">Utilizarás el token recibido para confirmar la transacción mediante el SDK.</p>

{% filter highlight_code:"python" %}
tx = MallTransaction.build_for_integration(
        IntegrationCommerceCodes.WEBPAY_PLUS_MALL,
        IntegrationApiKeys.WEBPAY
    )
resp = tx.commit(token_ws)
{% endfilter %}

<h2 class="mt-32" id="response">Paso 3 - Respuesta:</h2>
<p class="mb-32">
    Una vez que la transacción ha sido confirmada, Transbank proporcionará la siguiente información.
    Es fundamental conservar esta respuesta y verificar que el campo "response_code" tenga un valor de cero y que el
    campo "status" sea "AUTHORIZED".
</p>

{{ response_data|prettyjson|highlight_code:"json" }}

<h2 class="mt-32">¡Listo!</h2>
<p class="mb-32">
    Con la confirmación exitosa, ya puedes mostrar al usuario una página de éxito de la transacción,
    proporcionándole la tranquilidad de que el proceso ha sido completado con éxito.
</p>

<p class="mb-16" id="operations">
    Después de confirmar la transacción, podrás realizar otras operaciones útiles:
</p>
<ul class="bullet-list mb-32">
    <li><span class="fw-700">Reembolsar:</span> Puedes reversar o anular el pago según ciertas condiciones comerciales.</li>
    <li><span class="fw-700">Consultar Estado:</span> Hasta 7 días después de la transacción, podrás consultar el estado de la transacción.</li>
</ul>

{% if response_data.details %}
    {% for detail in response_data.details %}
        <form action="{% url 'webpay_plus_mall:refund' %}" method="GET">
            <div class="tbk-refund-card mb-32">
                <div class="refund-card-title">Orden De Compra <span class="value">{{ detail.buy_order }}</span></div>
                <div class="input-container">
                    <label for="amount_{{ forloop.counter }}" class="tbk-label">Monto a reembolsar</label>
                    <input type="text" name="amount" id="amount_{{ forloop.counter }}" class="tbk-input-text" value="{{ detail.amount }}">
                    <input type="hidden" name="token" value="{{ token }}">
                    <input type="hidden" name="commerce_code" value="{{ detail.commerce_code }}">
                    <input type="hidden" name="buy_order" value="{{ detail.buy_order }}">
                </div>
                <div class="tbk-refund-button-container">
                    <button class="tbk-button primary">REEMBOLSAR</button>
                </div>
            </div>
        </form>
    {% endfor %}
{% endif %}

<a href="{% url 'webpay_plus_mall:status' %}?token={{ token }}" class="tbk-button primary mb-32">CONSULTAR ESTADO</a>

{% endblock %}
